components:
  schemas:
    Topics:
      type: object
      required:
        - organizationName
        - allowUndefinedTopics
        - topics
        - version
      properties:
        organizationName:
          type: string
        allowUndefinedTopics:
          type: boolean
        undefinedTopic:
          $ref: '#/components/schemas/Topic'
        topics:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/Topic'
        version:
          type: integer
          format: int64
    Topic:
      type: object
      properties:
        batch:
          $ref: '#/components/schemas/TopicBatch'
        streams:
          type: array
          items:
            $ref: '#/components/schemas/TopicStream'
        store:
          $ref: '#/components/schemas/TopicStore'
    TopicBatch:
      type: object
      properties:
        retentionInDays:
          type: integer
          format: int64
    TopicStream:
      type: object
      required:
        - name
      properties:
        name:
          type: string
    TopicStore:
      type: object
      required:
        - keys
        - ttlInSec
      properties:
        keys:
          type: array
          items:
            $ref: '#/components/schemas/TopicStoreKey'
        ttlInSec:
          type: integer
          format: int64
        blacklist:
          type: array
          items:
            type: string
        whitelist:
          type: array
          items:
            type: string
    TopicStoreKey:
      type: object
      required:
        - tableType
        - pkParts
        - rangePrefix
      properties:
        tableType:
          type: string
          enum:
            - PRIMARY
            - GSI
            - LSI
        indexNumber:
          type: integer
          format: int64
        pkParts:
          type: array
          items:
            type: string
        skParts:
          type: array
          items:
            type: string
        rangePrefix:
          type: string
    TopicSchema:
      type: object
      required:
        - schema
        - format
      properties:
        schema:
          type: string
        format:
          $ref: '#/components/schemas/SchemaFormat'
    UpdateTopicSchemaRequest:
      type: object
      required:
        - schema
        - format
      properties:
        schema:
          type: string
        format:
          $ref: '#/components/schemas/SchemaFormat'
    SchemaFormat:
      title: SchemaFormat
      type: string
      enum:
        - JSON
    TopicFilesResponse:
      type: object
      required:
        - files
      properties:
        files:
          type: array
          items:
            $ref: '#/components/schemas/S3Object'
        nextToken:
          type: string
    S3Object:
      type: object
      required:
        - key
        - size
        - lastModified
      properties:
        key:
          type: string
          description: S3 object key
        size:
          type: integer
          format: int64
          description: File size in bytes
        lastModified:
          type: string
          format: date-time
          description: Last modified timestamp
    FileDownloadUrlResponse:
      type: object
      required:
        - url
        - expiresAt
      properties:
        url:
          type: string
          description: Presigned URL for downloading the file
        expiresAt:
          type: string
          format: date-time
          description: URL expiration time

/v1/organization/{organizationName}/topics:
  get:
    operationId: getTopics
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
    responses:
      '200':
        description: Ok
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Topics'

/v1/organization/{organizationName}/topic/default:
  patch:
    operationId: updateDefaultTopic
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: expectedVersion
        in: query
        required: false
        schema:
          type: integer
          format: int64
    requestBody:
      required: true
      content:
        application/json:
          schema:
            title: UpdateDefaultTopicRequest
            type: object
            required:
              - allowUndefined
            properties:
              allowUndefined:
                type: boolean
              topic:
                $ref: '#/components/schemas/Topic'
    responses:
      '200':
        description: Ok
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Topics'
/v1/organization/{organizationName}/topic/{topicName}:
  patch:
    operationId: updateTopic
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
      - name: expectedVersion
        in: query
        required: false
        schema:
          type: integer
          format: int64
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Topic'
    responses:
      '200':
        description: Ok
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Topics'
  delete:
    operationId: deleteTopic
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
      - name: expectedVersion
        in: query
        required: false
        schema:
          type: integer
          format: int64
    responses:
      '200':
        description: Ok
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Topics'
/v1/organization/{organizationName}/topic/{topicName}/schema:
  get:
    operationId: getTopicSchema
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
    responses:
      '200':
        description: Ok
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopicSchema'
      '404':
        description: Schema not found
  put:
    operationId: updateTopicSchema
    tags: [ Control ]
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
    requestBody:
      required: true
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/UpdateTopicSchemaRequest'
    responses:
      '201':
        description: Schema created
      '200':
        description: Schema unchanged or not needed
      '400':
        description: Schema validation failed
  post:
    operationId: recalculateTopicSchema
    tags: [ Control ]
    summary: Recalculate schema from ingested S3 data
    description: Infers the schema from actual data stored in S3 and updates the Glue table definition
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
    responses:
      '200':
        description: Schema recalculated successfully
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopicSchema'
      '404':
        description: Topic not found or no data available
      '400':
        description: Topic does not have batch enabled
/v1/organization/{organizationName}/topic/{topicName}/files:
  get:
    operationId: listTopicFiles
    tags: [ Control ]
    summary: List files stored in S3 for a topic
    description: Lists objects in S3 for a batch-enabled topic with pagination support
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
      - name: prefix
        in: query
        required: false
        description: Prefix to filter files (e.g., "year=2025/month=01/")
        schema:
          type: string
      - name: maxResults
        in: query
        required: false
        description: Maximum number of files to return (default 100, max 1000)
        schema:
          type: integer
          format: int32
          default: 100
      - name: nextToken
        in: query
        required: false
        description: Continuation token for pagination
        schema:
          type: string
    responses:
      '200':
        description: List of files
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TopicFilesResponse'
      '404':
        description: Topic not found
      '400':
        description: Topic does not have batch enabled
/v1/organization/{organizationName}/topic/{topicName}/files/download:
  get:
    operationId: getTopicFileDownloadUrl
    tags: [ Control ]
    summary: Get presigned URL to download a file
    description: Generates a temporary presigned URL for downloading a specific file from S3
    parameters:
      - name: organizationName
        in: path
        required: true
        schema:
          type: string
      - name: topicName
        in: path
        required: true
        schema:
          type: string
      - name: key
        in: query
        required: true
        description: S3 object key to download
        schema:
          type: string
    responses:
      '200':
        description: Presigned URL generated
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FileDownloadUrlResponse'
      '404':
        description: File not found
      '400':
        description: Invalid request